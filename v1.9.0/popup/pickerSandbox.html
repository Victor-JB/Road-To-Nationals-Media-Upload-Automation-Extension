<!DOCTYPE html>
<html>
	<head>
		<title>Google Drive Picker</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}
			body {
				font-family: "Segoe UI", Roboto, sans-serif;
				background: #f5f5f5;
				display: flex;
				justify-content: center;
				align-items: center;
				min-height: 100vh;
			}
			.loading {
				text-align: center;
				color: #666;
			}
			.loading-spinner {
				border: 3px solid #f3f3f3;
				border-top: 3px solid #4285f4;
				border-radius: 50%;
				width: 40px;
				height: 40px;
				animation: spin 1s linear infinite;
				margin: 0 auto 16px;
			}
			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}
			.error {
				color: #d93025;
				text-align: center;
				padding: 20px;
			}
		</style>
	</head>
	<body>
		<div id="status" class="loading">
			<div class="loading-spinner"></div>
			<p>Loading Google Drive Picker...</p>
		</div>

		<!-- Load Google API - allowed in sandbox with proper CSP -->
		<script src="https://apis.google.com/js/api.js"></script>
		<script>
			const statusEl = document.getElementById("status");

			function showError(msg) {
				statusEl.className = "error";
				statusEl.innerHTML = "<p>" + msg + "</p>";
			}

			// Get config and token from URL params (passed by parent)
			const params = new URLSearchParams(window.location.search);
			const token = params.get("token");
			const developerKey = params.get("developerKey");
			const appId = params.get("appId");

			if (!token || !developerKey || !appId) {
				showError("Missing configuration. Please try again.");
			} else {
				gapi.load("picker", { callback: initPicker });
			}

			function initPicker() {
				try {
					const videoView = new google.picker.DocsView()
						.setIncludeFolders(false)
						.setSelectFolderEnabled(false)
						.setMimeTypes(
							"video/mp4,video/quicktime,video/x-msvideo,video/webm,video/mpeg"
						);

					const folderView = new google.picker.DocsView()
						.setIncludeFolders(true)
						.setSelectFolderEnabled(true)
						.setMimeTypes("application/vnd.google-apps.folder");

					const picker = new google.picker.PickerBuilder()
						.setAppId(appId)
						.setDeveloperKey(developerKey)
						.setOAuthToken(token)
						.enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
						.addView(folderView)
						.addView(videoView)
						.setCallback(pickerCallback)
						.setTitle("Select Videos or a Folder")
						.build();

					picker.setVisible(true);
					statusEl.style.display = "none";
				} catch (err) {
					showError("Failed to create picker: " + err.message);
				}
			}

			function pickerCallback(data) {
				const action = data[google.picker.Response.ACTION];
				if (action === google.picker.Action.PICKED) {
					const docs = data[google.picker.Response.DOCUMENTS] || [];
					// Post to parent window (the pickerWindow.html)
					window.parent.postMessage({ type: "picked", docs: docs }, "*");
				} else if (action === google.picker.Action.CANCEL) {
					window.parent.postMessage({ type: "cancel" }, "*");
				}
			}
		</script>
	</body>
</html>
